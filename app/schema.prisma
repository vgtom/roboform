datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'free', 'starter', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(5) // Free plan gets 5 credits
  aiUsageCount               Int             @default(0) // Track AI request count (prompts/modifications)

  gptResponses              GptResponse[]
  contactFormMessages       ContactFormMessage[]
  tasks                     Task[]
  files                     File[]
  organizationMembers       OrganizationMember[]
}

model GptResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
}

model Task {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  description               String
  time                      String          @default("1")
  isDone                    Boolean         @default(false)
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  s3Key                     String
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

model Organization {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  name                      String
  slug                      String          @unique

  members                   OrganizationMember[]
  workspaces                 Workspace[]
}

enum OrganizationRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model OrganizationMember {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                    String

  organization              Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId            String

  role                      OrganizationRole @default(VIEWER)

  @@unique([userId, organizationId])
}

model Workspace {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  name                      String
  slug                      String

  organization              Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId            String

  forms                     Form[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

enum FormStatus {
  DRAFT
  PUBLISHED
}

model Form {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  publishedAt               DateTime?

  name                      String
  slug                      String
  status                    FormStatus      @default(DRAFT)
  schemaJson                Json            // SOURCE OF TRUTH - JSON schema for form structure

  workspace                 Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId               String

  responses                 FormResponse[]
  analytics                 FormAnalytics?

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([slug])
}

model FormResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  form                      Form            @relation(fields: [formId], references: [id], onDelete: Cascade)
  formId                    String

  responseJson              Json            // User's response data
  metadata                  Json?           // IP, user agent, etc.

  @@index([formId])
}

model FormAnalytics {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  form                      Form            @relation(fields: [formId], references: [id], onDelete: Cascade)
  formId                    String          @unique

  views                     Int             @default(0)
  submissions               Int             @default(0)
  completionRate            Float           @default(0)

  @@index([formId])
}
